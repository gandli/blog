name: Translate Markdown Posts

on:
  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      file_path:
        description: "è¾“å…¥éœ€è¦ç¿»è¯‘çš„æ–‡ä»¶è·¯å¾„ (å¦‚ï¼šcontent/posts/ç¤ºä¾‹.md)"
        required: false
        default: ""
      force:
        description: "å¼ºåˆ¶é‡æ–°ç¿»è¯‘ (å³ä½¿å·²å­˜åœ¨ç¿»è¯‘)"
        required: false
        default: "false"

jobs:
  prepare:
    name: "æ‰«æå¾…ç¿»è¯‘æ–‡ä»¶"
    runs-on: ubuntu-latest
    outputs:
      files_to_translate: ${{ steps.detect.outputs.files }}
      has_files: ${{ steps.detect.outputs.has_files }}
    
    steps:
      - name: "æ£€å‡ºä»£ç åº“"
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "è®¾ç½®ç¯å¢ƒå˜é‡"
        run: |
          echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "EVENT_TYPE=${{ github.event_name }}" >> $GITHUB_ENV

      - name: "æ£€æµ‹å¾…å¤„ç†æ–‡ä»¶"
        id: detect
        run: |
          # è®¾ç½® IFS åªå¤„ç†æ¢è¡Œç¬¦
          IFS=$'\n'
          
          # æ’é™¤è§„åˆ™é…ç½®
          EXCLUDE_PATTERNS=(
            "_*.md"
            "*_en.md"
          )
          
          EXCLUDE_DIRS=(
            "themes/**"
            "assets/**"
            "node_modules/**"
            ".github/**"
            "public/**"
            "resources/**"
          )

          # å¤„ç†æ‰‹åŠ¨è§¦å‘
          if [[ "$EVENT_TYPE" == "workflow_dispatch" ]]; then
            input_file="${{ github.event.inputs.file_path }}"
            force="${{ github.event.inputs.force }}"
            
            if [[ -n "$input_file" ]]; then
              if [[ ! -f "$input_file" ]]; then
                echo "::error::æ–‡ä»¶ä¸å­˜åœ¨ï¼š$input_file"
                exit 1
              fi
              
              if [[ "$input_file" != *.md ]]; then
                echo "::error::ä»…æ”¯æŒ Markdown æ–‡ä»¶ï¼š$input_file"
                exit 1
              fi

              # å¤„ç†å¸¦ç©ºæ ¼çš„æ–‡ä»¶å
              base="${input_file%.*}"
              en_file="${base}_en.md"

              if [[ "$force" == "true" || ! -f "$en_file" ]]; then
                echo "::notice::æ–‡ä»¶åŠ å…¥ç¿»è¯‘é˜Ÿåˆ—ï¼š$input_file"
                # ä½¿ç”¨ jq çš„--arg å®‰å…¨ä¼ é€’å¯èƒ½åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å
                echo "files=$(jq -cn --arg file "$input_file" '[$file]')" >> "$GITHUB_OUTPUT"
                echo "has_files=true" >> "$GITHUB_OUTPUT"
                exit 0
              else
                echo "::notice::ç¿»è¯‘æ–‡ä»¶å·²å­˜åœ¨ï¼š$en_file"
                echo "files=[]" >> "$GITHUB_OUTPUT"
                echo "has_files=false" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          fi

          # ç”Ÿæˆ find æ’é™¤å‚æ•°
          find_exclude=()
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            find_exclude+=(-not -name "$pattern")
          done
          
          for dir in "${EXCLUDE_DIRS[@]}"; do
            find_exclude+=(-not -path "./$dir")
          done

          # æ‰«ææ‰€æœ‰æœªç¿»è¯‘çš„ Markdown æ–‡ä»¶
          echo "::group::æ‰«ææ‰€æœ‰æœªç¿»è¯‘çš„ Markdown æ–‡ä»¶"
          untranslated_files=()
          while IFS= read -r -d '' file; do
            # å¤„ç†å¸¦ç©ºæ ¼çš„æ–‡ä»¶å
            base="${file%.*}"
            en_file="${base}_en.md"
            
            if [[ ! -f "$en_file" ]]; then
              untranslated_files+=("$file")
            fi
          done < <(find . -type f -name "*.md" "${find_exclude[@]}" -print0)
          echo "::endgroup::"

          # æ‰«æå˜æ›´çš„æ–‡ä»¶
          echo "::group::æ‰«æå˜æ›´çš„ Markdown æ–‡ä»¶"
          changed_files=$(git diff --name-only -z HEAD^ HEAD | grep -z '\.md$' | tr '\0' '\n' || true)
          
          if [[ -z "$changed_files" ]]; then
            echo "::notice::æœ¬æ¬¡æäº¤æœªä¿®æ”¹ä»»ä½• Markdown æ–‡ä»¶"
          else
            # å¤„ç†å˜æ›´æ–‡ä»¶
            changed_result=()
            while IFS= read -r file; do
              # æ£€æŸ¥æ’é™¤è§„åˆ™
              exclude=false
              
              for pattern in "${EXCLUDE_PATTERNS[@]}"; do
                if [[ "$(basename "$file")" == $pattern ]]; then
                  exclude=true
                  break
                fi
              done
              
              for dir in "${EXCLUDE_DIRS[@]}"; do
                if [[ "$file" == "./$dir"* || "$file" == "$dir"* ]]; then
                  exclude=true
                  break
                fi
              done

              if [[ "$exclude" == "false" ]]; then
                base="${file%.*}"
                en_file="${base}_en.md"
                
                if [[ -f "$en_file" ]] && [[ $(git diff --name-only HEAD^ HEAD -- "$file") ]]; then
                  echo "::notice::æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°ï¼š$file"
                  rm -f "$en_file"
                  changed_result+=("$file")
                fi
              fi
            done <<< "$changed_files"
          fi
          echo "::endgroup::"

          # åˆå¹¶ç»“æœ
          result=("${untranslated_files[@]}" "${changed_result[@]}")
          # å»é‡å¹¶ä¿æŒé¡ºåº
          unique_result=($(printf "%s\n" "${result[@]}" | awk '!seen[$0]++'))

          # è®¾ç½®è¾“å‡º
          if [[ ${#unique_result[@]} -gt 0 ]]; then
            echo "::notice::å‘ç° ${#unique_result[@]} ä¸ªå¾…å¤„ç†æ–‡ä»¶"
            # å®‰å…¨å¤„ç†å¸¦ç©ºæ ¼çš„æ–‡ä»¶å
            printf "%s\n" "${unique_result[@]}" | jq -R . | jq -s . | jq -c 'map(select(. != ""))' > files.json
            echo "files=$(cat files.json)" >> "$GITHUB_OUTPUT"
            echo "has_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::æ²¡æœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶"
            echo "files=[]" >> "$GITHUB_OUTPUT"
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          fi

  translate:
    name: "æ‰§è¡Œç¿»è¯‘"
    needs: prepare
    if: needs.prepare.outputs.has_files == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: "æ£€å‡ºä»£ç åº“"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: "è®¾ç½® Python ç¯å¢ƒ"
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: "å®‰è£…ä¾èµ–"
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv
          echo "âœ”ï¸ ä¾èµ–å®‰è£…å®Œæˆ"

      - name: "ç¿»è¯‘ Markdown æ–‡ä»¶"
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          echo "::group::ç¿»è¯‘å¤„ç†æ—¥å¿—"
          # ä½¿ç”¨ jq å®‰å…¨è¯»å–å¯èƒ½åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å
          files_json='${{ needs.prepare.outputs.files_to_translate }}'
          echo "åŸå§‹æ–‡ä»¶åˆ—è¡¨: $files_json"
          
          # ä½¿ç”¨ jq ç”Ÿæˆå®‰å…¨çš„ shell æ•°ç»„
          mapfile -t files < <(echo "$files_json" | jq -r '.[] | @json')
          
          echo "å³å°†å¤„ç† ${#files[@]} ä¸ªæ–‡ä»¶ï¼š"
          
          for file_json in "${files[@]}"; do
            # ä½¿ç”¨ jq è§£æ JSON å­—ç¬¦ä¸²ï¼Œä¿ç•™åŸå§‹è·¯å¾„
            file=$(echo "$file_json" | jq -r '.')
            echo "ğŸ” æ­£åœ¨å¤„ç†: $file"
            
            if [[ ! -f "$file" ]]; then
              echo "::error::æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
              exit 1
            fi
            
            # ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
            file_path="$(realpath "$file")"
            echo "å®Œæ•´è·¯å¾„: $file_path"
            
            # æ‰§è¡Œç¿»è¯‘è„šæœ¬
            if ! python .github/scripts/translate_markdown.py "$file_path"; then
              echo "::error::ç¿»è¯‘å¤±è´¥ï¼š$file"
              exit 1
            fi
            
            echo "âœ… ç”Ÿæˆç¿»è¯‘: ${file%.*}_en.md"
          done
          echo "::endgroup::"

      - name: "æäº¤ç¿»è¯‘ç»“æœ"
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # æ·»åŠ æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶ï¼Œå¤„ç†å¸¦ç©ºæ ¼çš„æ–‡ä»¶å
          while IFS= read -r -d '' file; do
            git add "$file"
          done < <(find . -name "*_en.md" -print0)

          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸŒ è‡ªåŠ¨ç¿»è¯‘: æ›´æ–°è‹±æ–‡ç‰ˆæœ¬ [skip ci]"
            git push origin "HEAD:${{ github.ref_name }}"
            echo "ğŸš€ å·²æ¨é€ç¿»è¯‘æ–‡ä»¶åˆ°åˆ†æ”¯ ${{ github.ref_name }}"
          fi