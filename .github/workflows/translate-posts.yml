name: Translate Markdown Posts

on:
  push:
    paths:
      - 'content/**/*.md'
      - '!content/**/*_en.md'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Optional - Specific file path to translate'
        required: false
        default: ''

jobs:
  check-untranslated:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_untranslated: ${{ steps.check-files.outputs.has_untranslated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find untranslated files
        id: check-files
        run: |
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç»“æžœ
          UNTRANSLATED_FILES=$(mktemp)
          
          # æŸ¥æ‰¾æœªç¿»è¯‘æ–‡ä»¶
          while IFS= read -r -d '' file; do
            base="${file%.*}"
            if [[ ! -f "${base}_en.md" ]]; then
              echo "$file" >> "$UNTRANSLATED_FILES"
            fi
          done < <(find content -name "*.md" ! -name "*_en.md" -print0)

          # è®¾ç½®è¾“å‡ºå˜é‡
          if [[ -s "$UNTRANSLATED_FILES" ]]; then
            echo "has_untranslated=true" >> "$GITHUB_OUTPUT"
            echo "untranslated_files<<EOF" >> "$GITHUB_OUTPUT"
            cat "$UNTRANSLATED_FILES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "has_untranslated=false" >> "$GITHUB_OUTPUT"
          fi
          rm -f "$UNTRANSLATED_FILES"

  translate:
    needs: check-untranslated
    if: needs.check-untranslated.outputs.has_untranslated == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv

      - name: Translate files
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          # è¯»å–æœªç¿»è¯‘æ–‡ä»¶åˆ—è¡¨
          while IFS= read -r file; do
            echo "ðŸ” Processing: $file"
            if python .github/scripts/translate_markdown.py "$file"; then
              echo "âœ… Translated: $file"
              echo "${file%.*}_en.md" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âŒ Failed to translate: $file" >&2
            fi
          done <<< "${{ needs.check-untranslated.outputs.untranslated_files }}"

      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é…ç½®Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ·»åŠ ç¿»è¯‘æ–‡ä»¶
          while IFS= read -r file; do
            translated_file="${file%.*}_en.md"
            if [[ -f "$translated_file" ]]; then
              git add "$translated_file"
            fi
          done <<< "${{ needs.check-untranslated.outputs.untranslated_files }}"
          
          # æäº¤å˜æ›´
          if ! git diff --cached --quiet; then
            git commit -m "Auto-translate: Add English versions [skip ci]"
            git push origin "HEAD:${{ github.ref_name }}"
            echo "ðŸš€ Successfully pushed translations"
          else
            echo "â„¹ï¸ No translations to commit"
          fi
