name: Translate Markdown Posts

on:
  push:
    paths:
      - 'content/**/*.md'
      - '!content/**/*_en.md'  # æ’é™¤å·²ç¿»è¯‘çš„æ–‡ä»¶
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      file_path:
        description: 'Optional - Specific file path to translate (e.g. content/my_post.md)'
        required: false
        default: ''

jobs:
  check-untranslated:
    runs-on: ubuntu-latest
    outputs:
      has_untranslated: ${{ steps.check-files.outputs.has_untranslated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find untranslated files
        id: check-files
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰æœªç¿»è¯‘çš„Markdownæ–‡ä»¶
          files=$(find content -name "*.md" ! -name "*_en.md")
          
          # æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æ˜¯å¦æœ‰å¯¹åº”çš„ç¿»è¯‘ç‰ˆæœ¬
          untranslated_files=()
          for file in $files; do
            base="${file%.*}"
            if [[ ! -f "${base}_en.md" ]]; then
              untranslated_files+=("$file")
            fi
          done
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          if [ ${#untranslated_files[@]} -gt 0 ]; then
            echo "Found untranslated files: ${untranslated_files[@]}"
            echo "has_untranslated=true" >> $GITHUB_OUTPUT
          else
            echo "No untranslated files found"
            echo "has_untranslated=false" >> $GITHUB_OUTPUT
          fi
  translate:
    needs: check-untranslated
    if: needs.check-untranslated.outputs.has_untranslated == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            content/**/*.md
            !content/**/*_en.md
      - name: Get untranslated files
        id: untranslated-files
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰æœªç¿»è¯‘çš„Markdownæ–‡ä»¶
          files=$(find content -name "*.md" ! -name "*_en.md")
          
          # ç­›é€‰å‡ºæ²¡æœ‰å¯¹åº”ç¿»è¯‘ç‰ˆæœ¬çš„æ–‡ä»¶
          untranslated_files=()
          for file in $files; do
            base="${file%.*}"
            if [[ ! -f "${base}_en.md" ]]; then
              untranslated_files+=("$file")
            fi
          done
          
          echo "files_to_translate=${untranslated_files[@]}" >> $GITHUB_OUTPUT
      - name: Translate Markdown files
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          # ä½¿ç”¨æ•°ç»„å­˜å‚¨æ–‡ä»¶åˆ—è¡¨ï¼Œæ­£ç¡®å¤„ç†å¸¦ç©ºæ ¼çš„æ–‡ä»¶å
          files=()
          while IFS= read -r -d '' file; do
            files+=("$file")
          done < <(find content -name "*.md" ! -name "*_en.md" -print0)
          
          # æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶æ˜¯å¦æœ‰å¯¹åº”çš„ç¿»è¯‘ç‰ˆæœ¬
          for file in "${files[@]}"; do
            base="${file%.*}"
            if [[ ! -f "${base}_en.md" ]]; then
              echo "ğŸ” å‘ç°æœªç¿»è¯‘æ–‡ä»¶: $file"
              python .github/scripts/translate_markdown.py "$file"
            else
              echo "â© è·³è¿‡å·²ç¿»è¯‘æ–‡ä»¶: $file"
            fi
          done
          
      - name: Commit and push translations
        if: steps.untranslated-files.outputs.files_to_translate != '[]'
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ·»åŠ æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶
          git add content/**/*_en.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„ç¿»è¯‘æ–‡ä»¶"
          else
            # æäº¤å˜æ›´
            git commit -m "Auto-translate: Added English versions [skip ci]"
            
            # æ¨é€å˜æ›´
            git push origin "HEAD:${{ github.ref_name }}"
            echo "å·²æˆåŠŸæäº¤å¹¶æ¨é€ç¿»è¯‘æ–‡ä»¶"
          fi
