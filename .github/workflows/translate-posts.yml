name: Translate Markdown Posts

on:
  push:
    paths:
      - '**/*.md'             # ç›‘æ§æ‰€æœ‰ç›®å½•ä¸‹çš„ .md æ–‡ä»¶
      - '!**/_*.md'           # æ’é™¤æ‰€æœ‰ä»¥ _ å¼€å¤´çš„æ–‡ä»¶ï¼ˆå¦‚ _draft.mdï¼‰
      - '!**/*_en.md'         # æ’é™¤æ‰€æœ‰å·²å­˜åœ¨çš„ç¿»è¯‘æ–‡ä»¶ï¼ˆ*_en.mdï¼‰
      - '!**/default.md'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'å¯é€‰ - æŒ‡å®šè¦ç¿»è¯‘çš„æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ content/blog/ç¤ºä¾‹.mdï¼‰'
        required: false
        default: ''

jobs:
  prepare:
    name: "æ‰«æå¾…ç¿»è¯‘æ–‡ä»¶"
    runs-on: ubuntu-latest
    outputs:
      files_to_translate: ${{ steps.detect.outputs.files }}  # è¾“å‡ºå¾…ç¿»è¯‘æ–‡ä»¶åˆ—è¡¨
      has_files: ${{ steps.detect.outputs.has_files }}       # æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ç¿»è¯‘
    steps:
      - name: "æ£€å‡ºä»£ç åº“"
        uses: actions/checkout@v4

      - name: "æ£€æµ‹æœªç¿»è¯‘æ–‡ä»¶"
        id: detect
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†æ–‡ä»¶è·¯å¾„
          input_file="${{ github.event.inputs.file_path }}"
          result=()

          if [[ -n "$input_file" ]]; then
            # æ£€æŸ¥ï¼šæ–‡ä»¶å­˜åœ¨ ä¸” ä¸æ˜¯_å‰ç¼€ ä¸” ä¸æ˜¯ç¿»è¯‘æ–‡ä»¶
            if [[ -f "$input_file" && ! "$input_file" =~ /_ && ! "$input_file" =~ _en\.md$ ]]; then
              base="${input_file%.*}"
              # æ£€æŸ¥å¯¹åº”çš„ç¿»è¯‘æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
              if [[ ! -f "${base}_en.md" ]]; then
                result+=("$input_file")
              fi
            fi
          else
            # è‡ªåŠ¨æ‰«æå…¨ä»“åº“
            while IFS= read -r -d '' file; do
              # è·³è¿‡ä»¥ _ å¼€å¤´çš„æ–‡ä»¶å
              if [[ "$(basename "$file")" =~ ^_ ]]; then
                continue
              fi
              base="${file%.*}"
              # æ£€æŸ¥å¯¹åº”çš„ç¿»è¯‘æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
              if [[ ! -f "${base}_en.md" ]]; then
                result+=("$file")
              fi
            done < <(find . -name "*.md" ! -name "_*.md" ! -name "*_en.md" -print0)
          fi

          # è®¾ç½®è¾“å‡ºå‚æ•°
          if [[ ${#result[@]} -gt 0 ]]; then
            echo "æ£€æµ‹åˆ° ${#result[@]} ä¸ªå¾…ç¿»è¯‘æ–‡ä»¶"
            echo "files=$(jq -cn --argjson arr "$(printf '%s\n' "${result[@]}" | jq -R . | jq -s .)" '$arr')" >> "$GITHUB_OUTPUT"
            echo "has_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ æ²¡æœ‰éœ€è¦ç¿»è¯‘çš„æ–‡ä»¶"
            echo "files=[]" >> "$GITHUB_OUTPUT"
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          fi

  translate:
    name: "æ‰§è¡Œç¿»è¯‘"
    needs: prepare
    if: needs.prepare.outputs.has_files == 'true'  # åªæœ‰æœ‰å¾…ç¿»è¯‘æ–‡ä»¶æ—¶æ‰è¿è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: "æ£€å‡ºä»£ç åº“"
        uses: actions/checkout@v4

      - name: "è®¾ç½® Python ç¯å¢ƒ"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "å®‰è£…ä¾èµ–"
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv
          echo "âœ”ï¸ ä¾èµ–å®‰è£…å®Œæˆ"

      - name: "ç¿»è¯‘ Markdown æ–‡ä»¶"
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}  # ä»ä»“åº“ Secrets è¯»å– API å¯†é’¥
        run: |
          readarray -t files < <(echo '${{ needs.prepare.outputs.files_to_translate }}' | jq -r '.[]')
          echo "å³å°†ç¿»è¯‘ ${#files[@]} ä¸ªæ–‡ä»¶ï¼š"

          for file in "${files[@]}"; do
            echo "ğŸ” æ­£åœ¨ç¿»è¯‘ $file"
            python .github/scripts/translate_markdown.py "$file"
            echo "âœ“ ç¿»è¯‘å®Œæˆ: ${file%.*}_en.md"
          done

      - name: "æäº¤ç¿»è¯‘ç»“æœ"
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # æ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„ _en.md æ–‡ä»¶
          git add **/*_en.md

          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "è‡ªåŠ¨ç¿»è¯‘: æ–°å¢è‹±æ–‡ç‰ˆæœ¬ [skip ci]"
            git push origin "HEAD:${{ github.ref_name }}"
            echo "ğŸš€ å·²æ¨é€ç¿»è¯‘æ–‡ä»¶åˆ°åˆ†æ”¯ ${{ github.ref_name }}"
          fi
