name: Markdownæ–‡ç« è‡ªåŠ¨ç¿»è¯‘

on:
  push:
    paths:
      - 'content/**/*.md'
      - '!content/**/*_en.md'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'å¯é€‰ - æŒ‡å®šè¦ç¿»è¯‘çš„æ–‡ä»¶è·¯å¾„ (e.g. content/my_post.md)'
        required: false
        default: ''

jobs:
  check-untranslated:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_untranslated: ${{ steps.check-files.outputs.has_untranslated }}
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æŸ¥æ‰¾æœªç¿»è¯‘æ–‡ä»¶
        id: check-files
        run: |
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          UNTRANSLATED_FILES=$(mktemp)
          
          echo "å¼€å§‹æ‰«æéœ€è¦ç¿»è¯‘çš„æ–‡ä»¶..."
          while IFS= read -r -d '' file; do
            base="${file%.*}"
            if [[ ! -f "${base}_en.md" ]]; then
              echo "$file" >> "$UNTRANSLATED_FILES"
              echo "å‘ç°å¾…ç¿»è¯‘æ–‡ä»¶: $file"
            fi
          done < <(find content -name "*.md" ! -name "*_en.md" -print0)

          # è®¾ç½®è¾“å‡ºç»“æœ
          if [[ -s "$UNTRANSLATED_FILES" ]]; then
            echo "å­˜åœ¨æœªç¿»è¯‘æ–‡ä»¶: æ˜¯"
            echo "has_untranslated=true" >> "$GITHUB_OUTPUT"
            echo "untranslated_files<<EOF" >> "$GITHUB_OUTPUT"
            cat "$UNTRANSLATED_FILES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "å­˜åœ¨æœªç¿»è¯‘æ–‡ä»¶: å¦"
            echo "has_untranslated=false" >> "$GITHUB_OUTPUT"
          fi
          rm -f "$UNTRANSLATED_FILES"
          echo "æ–‡ä»¶æ‰«æå®Œæˆ"

  translate:
    needs: check-untranslated
    if: needs.check-untranslated.outputs.has_untranslated == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "æ­£åœ¨å®‰è£…Pythonä¾èµ–..."
          python -m pip install --upgrade pip
          pip install openai python-dotenv
          echo "ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ‰§è¡Œç¿»è¯‘
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          echo "å¼€å§‹ç¿»è¯‘æµç¨‹..."
          while IFS= read -r file; do
            echo "ğŸ”„ æ­£åœ¨å¤„ç†: $file"
            if python .github/scripts/translate_markdown.py "$file"; then
              echo "âœ… ç¿»è¯‘æˆåŠŸ: $file"
              echo "${file%.*}_en.md" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âŒ ç¿»è¯‘å¤±è´¥: $file" >&2
            fi
          done <<< "${{ needs.check-untranslated.outputs.untranslated_files }}"
          echo "æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ"

      - name: æäº¤ç¿»è¯‘ç»“æœ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å‡†å¤‡æäº¤ç¿»è¯‘ç»“æœ..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          added_files=0
          while IFS= read -r file; do
            translated_file="${file%.*}_en.md"
            if [[ -f "$translated_file" ]]; then
              git add "$translated_file"
              added_files=$((added_files+1))
              echo "å·²æš‚å­˜æ–‡ä»¶: $translated_file"
            fi
          done <<< "${{ needs.check-untranslated.outputs.untranslated_files }}"
          
          if ! git diff --cached --quiet; then
            git commit -m "è‡ªåŠ¨ç¿»è¯‘: æ–°å¢è‹±æ–‡ç‰ˆæœ¬ [skip ci]"
            git push origin "HEAD:${{ github.ref_name }}"
            echo "ğŸ‰ æˆåŠŸæäº¤ $added_files ä¸ªç¿»è¯‘æ–‡ä»¶"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„å˜æ›´"
          fi
